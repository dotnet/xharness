<Project DefaultTargets="Test">
  <Import Sdk="Microsoft.DotNet.Helix.Sdk" Project="Sdk.props"/>

  <PropertyGroup>
    <TargetFramework>netcoreapp3.1</TargetFramework>
    <!-- Workaround changes from newer MSBuild requiring additional properties, see https://github.com/dotnet/arcade/pull/5996 -->
    <TargetFrameworkVersion>3.1</TargetFrameworkVersion>
    <TargetFrameworkIdentifier>.NETCoreApp</TargetFrameworkIdentifier>
    <HelixType>test/product/</HelixType>
    <IncludeXHarnessCli>true</IncludeXHarnessCli>
    <TestRunNamePrefix>$(AGENT_JOBNAME)</TestRunNamePrefix>
    <EnableAzurePipelinesReporter>true</EnableAzurePipelinesReporter>
    <HelixBaseUri>https://helix.dot.net</HelixBaseUri>
    <!-- Pick up the nupkg from this repo for testing purposes -->
    <MicrosoftDotNetXHarnessCLIVersion>1.0.0-ci</MicrosoftDotNetXHarnessCLIVersion>
    <XHarnessNupkgPath>$(MSBuildThisFileDirectory)../../../artifacts/packages/$(Configuration)/Shipping/Microsoft.DotNet.XHarness.CLI.$(MicrosoftDotNetXHarnessCLIVersion).nupkg</XHarnessNupkgPath>

    <!-- Required: Version of XHarness CLI to use -->
    <IncludeXHarnessCli>true</IncludeXHarnessCli>

    <!-- Required: Version of XHarness CLI to use. Check the NuGet feed for current version: https://dev.azure.com/dnceng/public/_packaging?_a=package&feed=dotnet-eng&package=Microsoft.DotNet.XHarness.CLI&protocolType=NuGet -->
    <MicrosoftDotNetXHarnessCLIVersion>1.0.0-prerelease.20322.1</MicrosoftDotNetXHarnessCLIVersion>

    <!-- Optional: Properties that are also valid for the Arcade Helix SDK (some might be needed for CI runs only) -->
    <HelixType>test/product/</HelixType>
    <HelixBaseUri>https://helix.int-dot.net</HelixBaseUri>
    <Creator>$(BUILD_SOURCEVERSIONAUTHOR)</Creator>
    <EnableXUnitReporter>true</EnableXUnitReporter>
    <EnableAzurePipelinesReporter>true</EnableAzurePipelinesReporter>
  </PropertyGroup>

  <!-- For non-ci local runs -->
  <PropertyGroup Condition=" '$(AGENT_JOBNAME)' == '' ">
    <EnableAzurePipelinesReporter>false</EnableAzurePipelinesReporter>
    <MicrosoftDotNetXHarnessCLIVersion>1.0.0-dev</MicrosoftDotNetXHarnessCLIVersion>
  </PropertyGroup>

  <PropertyGroup>
    <XHarnessNupkgPath>$(ArtifactsShippingPackagesDir)/Microsoft.DotNet.XHarness.CLI.$(MicrosoftDotNetXHarnessCLIVersion).nupkg</XHarnessNupkgPath>
  </PropertyGroup>

  <!-- Required: Configuration that is already needed for the Helix SDK -->
  <ItemGroup>
    <HelixTargetQueue Include="ubuntu.1804.amd64.android.open"/>
  </ItemGroup>

  <PropertyGroup Condition=" '$(HelixAccessToken)' == '' ">
    <IsExternal>true</IsExternal>
    <Creator>$(BUILD_SOURCEVERSIONAUTHOR)</Creator>
    <Creator Condition=" '$(Creator)' == '' ">anon</Creator>
  </PropertyGroup>

  <PropertyGroup>
    <XHarnessX86TestApkUrl>https://netcorenativeassets.blob.core.windows.net/resource-packages/external/android/test-apk/x86/System.Numerics.Vectors.Tests-x86.apk</XHarnessX86TestApkUrl>
  </PropertyGroup>

  <!-- Useless stuff to make Arcade SDK happy -->
  <PropertyGroup>
    <Language>msbuild</Language>
  </PropertyGroup>

  <Target Name="Build" BeforeTargets="CoreTest">

    <DownloadFile SourceUrl="$(XHarnessX86TestApkUrl)" DestinationFolder="$(ArtifactsTmpDir)apk/x86" SkipUnchangedFiles="True" Retries="5">
      <Output TaskParameter="DownloadedFile" ItemName="DownloadedApkFile" />
    </DownloadFile>

    <Message Text="Downloaded @(DownloadedApkFile) for XHarness Test purposes" Importance="High" />

    <ItemGroup>
      <HelixWorkItem Include="@(DownloadedApkFile)">
        <Command>dotnet exec $XHARNESS_CLI_PATH android install --package-name="net.dot.System.Numerics.Vectors.Tests" --app="$HELIX_WORKITEM_PAYLOAD/apk/x86/System.Numerics.Vectors.Tests-x86.apk"</Command>
        <PayloadArchive>@(DownloadedApkFile)</PayloadArchive>
      </HelixWorkItem>
    </ItemGroup>
  </Target>

  <Import Sdk="Microsoft.DotNet.Helix.Sdk" Project="Sdk.targets"/>
</Project>
