<Project Sdk="Microsoft.DotNet.Helix.Sdk">

  <ItemGroup>
    <HelixTargetQueue Include="Ubuntu.2204.Amd64.Android.Multi.Open"/>
  </ItemGroup>

  <PropertyGroup>
    <TestPackageName>net.dot.System.Buffers.Tests</TestPackageName>
    <TestInstrumentationName>net.dot.MonoRunner</TestInstrumentationName>
    <XHarnessX86TestApkUrl>$(AssetsBaseUri)/android/test-apk/x86/System.Buffers.Tests-x86.apk</XHarnessX86TestApkUrl>
    <TestAppDestinationDir>$(ArtifactsTmpDir)apk</TestAppDestinationDir>
  </PropertyGroup>

  <Target Name="TestAndroidEmulatorAutoStart" BeforeTargets="CoreTest">
    <DownloadFile 
      SourceUrl="$(XHarnessX86TestApkUrl)" 
      DestinationFolder="$(TestAppDestinationDir)" 
      SkipUnchangedFiles="True" 
      Retries="5">
      <Output TaskParameter="DownloadedFile" ItemName="DownloadedX86Apk" />
    </DownloadFile>

    <Message Text="Downloaded x86 APK: @(DownloadedX86Apk)" Importance="High" />

    <ItemGroup>
      <XHarnessApkToTest Include="@(DownloadedX86Apk)">
        <TestName>Auto-start-no-reset</TestName>
        <AndroidPackageName>$(TestPackageName)</AndroidPackageName>
        <AndroidInstrumentationName>$(TestInstrumentationName)</AndroidInstrumentationName>
        <WorkItemTimeout>00:15:00</WorkItemTimeout>
        <CustomCommands><![CDATA[
          set -ex
          echo "=== Test: Auto-start emulator without --reset-emulator ==="
          
          # XHarness will auto-start an emulator with API 30 since no device is available
          xharness android test \
            --app="$app" \
            --package-name="$package_name" \
            --instrumentation="$instrumentation_name" \
            --output-directory="$output_directory" \
            --device-arch=x86 \
            --api-version=30 \
            --verbosity=Debug
          
          exit_code=$?
          echo "Test exit code: $exit_code"
          exit $exit_code
        ]]></CustomCommands>
      </XHarnessApkToTest>
    </ItemGroup>
  </Target>

</Project>
